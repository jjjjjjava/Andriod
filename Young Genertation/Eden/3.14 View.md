[toc]

## 1.View初探

### 什么是 View？

- **定义**：View 是 Android 中所有 UI 组件的基类。任何可以在屏幕上显示的元素，如按钮、文本框、图像等，都是 View 的子类。
- **功能**：View 负责在屏幕上绘制内容并响应用户的交互（如触摸事件）。
- **用途**：通过组合和定制 View，可以构建复杂的用户界面。

### View 的基本功能

1. 测量：View知道自己的大小
2. **绘制**：View 知道如何在屏幕上绘制自己。
3. **布局**：View 可以知道自己在父容器中的位置。
4. **事件处理**：View 可以处理用户的输入事件，如触摸、点击、长按等。

### View 的生命周期

#### 1. 构造函数

- **作用**：用于初始化 View 对象。在代码中创建 View 或从 XML 布局文件中实例化 View 时调用。

#### 2. onMeasure(int widthMeasureSpec, int heightMeasureSpec)

- **作用**：测量 View 的大小。这个方法决定了 View 的宽度和高度。

- 示例：

  ```java
  @Override
  protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
      super.onMeasure(widthMeasureSpec, heightMeasureSpec);
      // 自定义测量逻辑
  }
  ```

#### 3. onLayout(boolean changed, int left, int top, int right, int bottom)

- **作用**：确定 View 的位置。这个方法决定了 View 在其父容器中的位置。

- 示例：

  ```java
  @Override
  protected void onLayout(boolean changed, int left, int top, int right, int bottom) {
      // 自定义布局逻辑
  }
  ```

#### 4. onDraw(Canvas canvas)

- **作用**：绘制 View 的内容。这个方法在 View 需要绘制时调用。

- 示例：

  ```java
  @Override
  protected void onDraw(Canvas canvas) {
      super.onDraw(canvas);
      // 自定义绘制逻辑
      Paint paint = new Paint();
      paint.setColor(Color.RED);
      canvas.drawRect(0, 0, getWidth(), getHeight(), paint);
  }
  ```

### 常见的 View 子类

1. **TextView**：用于显示文本的视图。
2. **ImageView**：用于显示图像的视图。
3. **Button**：用于用户点击的按钮。
4. **EditText**：用于用户输入文本的视图。
5. **RecyclerView**：用于显示大量数据的高效列表视图。

### View 的事件处理

View 负责处理用户输入事件，如触摸事件、点击事件等。

#### 示例：处理点击事件

```java
Button button = findViewById(R.id.my_button);
button.setOnClickListener(new View.OnClickListener() {
    @Override
    public void onClick(View v) {
        // 处理点击事件
    }
});
```

#### 示例：处理触摸事件

```java
@Override
public boolean onTouchEvent(MotionEvent event) {
    switch (event.getAction()) {
        case MotionEvent.ACTION_DOWN:
            // 处理按下事件
            return true;
        case MotionEvent.ACTION_MOVE:
            // 处理移动事件
            return true;
        case MotionEvent.ACTION_UP:
            // 处理抬起事件
            return true;
    }
    return super.onTouchEvent(event);
}
```



## 2.View再介绍

Android 中的 View 绘制流程包括三个主要阶段：`measure`（测量）、`layout`（布局）和 `draw`（绘制）。这些阶段通过 `ViewRootImpl` 对象来协调，它负责将 `WindowManager` 和 `DecorView` 连接起来，并完成 View 的绘制流程。

### 1. ViewRootImpl

- **ViewRootImpl** 是连接 `WindowManager` 和 `DecorView` 的桥梁。
- 当 Activity 被创建时，`DecorView` 会被添加到 `Window` 中，同时会创建 `ViewRootImpl` 对象，并将 `ViewRootImpl` 与 `DecorView` 关联。

### 2. 三大流程

#### a. Measure（测量）

- **作用**：计算每个 View 及其子 View 的大小。
- **主要方法**：`performMeasure()`, `measure()`, `onMeasure()`
- 过程：
  1. `performMeasure()`：`ViewRootImpl` 开始测量过程。
  2. `measure()`：递归调用每个子 View 的 `measure()` 方法。
  3. `onMeasure()`：实际计算 View 的大小，子类可以重写此方法来自定义测量逻辑。

#### b. Layout（布局）

- **作用**：确定每个 View 及其子 View 在父容器中的位置。
- **主要方法**：`performLayout()`, `layout()`, `onLayout()`
- 过程：
  1. `performLayout()`：`ViewRootImpl` 开始布局过程。
  2. `layout()`：递归调用每个子 View 的 `layout()` 方法。
  3. `onLayout()`：实际确定 View 的位置，子类可以重写此方法来自定义布局逻辑。

#### c. Draw（绘制）

- **作用**：将 View 绘制到屏幕上。
- **主要方法**：`performDraw()`, `draw()`, `onDraw()`
- 过程：
  1. `performDraw()`：`ViewRootImpl` 开始绘制过程。
  2. `draw()`：递归调用每个子 View 的 `draw()` 方法。
  3. `onDraw()`：实际绘制 View 的内容，子类可以重写此方法来自定义绘制逻辑。

### 流程图解

结合您提供的图解，这里是对 `performTraversals` 工作流程的具体解释：

```
erformTraversals
    |
    |--> performMeasure
    |         |
    |         |--> measure
    |                   |
    |                   |--> onMeasure
    |
    |--> performLayout
    |         |
    |         |--> layout
    |                   |
    |                   |--> onLayout
    |
    |--> performDraw
              |
              |--> draw
                        |
                        |--> onDraw
```

## 3.View和Activity以及Window

### 什么是 `ViewRootImpl`？

- **`ViewRootImpl`** 是 Android 框架中的一个关键类，负责管理 View 层次结构的绘制和事件分发。
- 它是 `WindowManager` 和应用程序的根视图（`DecorView`）之间的桥梁。

### 关键概念

1. **`WindowManager`**：管理窗口的系统服务，负责添加和管理应用程序窗口。
2. **`DecorView`**：每个窗口的顶层视图，包含应用程序窗口的内容视图和标题栏等装饰。
3. **`ViewRootImpl`**：连接 `WindowManager` 和 `DecorView` 的实现类，负责处理窗口中的 View 的测量、布局和绘制。

### 绘制流程

#### 1. Activity 创建并设置内容视图

当一个 Activity 被创建并调用 `setContentView` 时，系统会执行以下步骤：

```
java复制代码@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
}
```

- **`setContentView`**：设置 Activity 的布局资源。

#### 2. WindowManager 添加窗口

`setContentView` 最终会调用 `WindowManager` 的 `addView` 方法，将 `DecorView` 添加到窗口中。

```
java复制代码public void setContentView(View view) {
    getWindow().setContentView(view);
}

public void setContentView(View view, ViewGroup.LayoutParams params) {
    getWindow().setContentView(view, params);
}

public void addView(View view, ViewGroup.LayoutParams params) {
    // 调用 WindowManagerImpl 的 addView 方法
    mWindowManager.addView(view, params);
}
```

#### 3. ViewRootImpl 创建并关联 DecorView

在 `WindowManager` 的 `addView` 方法中，会创建一个 `ViewRootImpl` 实例，并将其与 `DecorView` 关联。

```
java复制代码public void addView(View view, ViewGroup.LayoutParams params) {
    // 创建 ViewRootImpl 实例
    ViewRootImpl root = new ViewRootImpl(view.getContext(), this);
    root.setView(view, params, view.getContext().getDisplay(), new WindowManager.LayoutParams());
}
```

#### 4. ViewRootImpl 协调绘制流程

`ViewRootImpl` 负责协调整个 View 的绘制流程，包括测量（measure）、布局（layout）和绘制（draw）阶段。以下是 `ViewRootImpl` 的主要方法：

- **performTraversals**：协调测量、布局和绘制的过程。
- **performMeasure**：执行测量。
- **performLayout**：执行布局。
- **performDraw**：执行绘制。



## 4.举例理解

好的，让我们通过微信应用程序中的一个实际页面来详细说明 `WindowManager`、`DecorView` 和 `ViewRootImpl` 是如何协同工作的。

### 1. WindowManager

**`WindowManager`** 是 Android 系统的窗口管理器，负责管理所有应用程序的窗口。每当一个新的窗口被添加到应用程序时，`WindowManager` 就会处理该窗口的添加、更新和删除操作。

在微信中，例如，当用户打开微信时，主聊天界面就是一个窗口，由 `WindowManager` 管理。

### 2. DecorView

**`DecorView`** 是每个窗口的顶层视图。它包含了应用程序的内容视图以及其他装饰元素，如标题栏、状态栏等。

在微信的主聊天界面中，`DecorView` 包含了整个聊天列表界面，以及顶部的搜索栏和底部的导航栏。

### 3. ViewRootImpl

**`ViewRootImpl`** 是连接 `WindowManager` 和 `DecorView` 的实现类。它负责处理窗口中的 View 的测量、布局和绘制过程。

在微信的主聊天界面中，`ViewRootImpl` 负责协调整个界面的测量、布局和绘制过程，确保每个聊天项和导航栏都能正确显示和响应用户的交互。